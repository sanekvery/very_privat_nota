# VPN Module

## ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ

ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ WireGuard VPN ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸. ĞĞ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚:
- Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ IP
- Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ VPN Agent Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ñ…
- Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ IP (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ race conditions)
- Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ¸ IP Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ²

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Layer                                â”‚
â”‚  POST /api/vpn/generate                                         â”‚
â”‚  POST /api/vpn/rotate                                           â”‚
â”‚  GET  /api/vpn/:configId                                        â”‚
â”‚  DELETE /api/vpn/:configId                                      â”‚
â”‚  GET  /api/vpn/subscription/:subscriptionId                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  VpnService  â”‚  â”‚WireGuardSvc  â”‚  â”‚  IpPoolSvc   â”‚         â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â”‚â€¢ Generate    â”‚  â”‚â€¢ Key Gen     â”‚  â”‚â€¢ Allocate IP â”‚         â”‚
â”‚  â”‚â€¢ Rotate      â”‚  â”‚  (X25519)    â”‚  â”‚  (CRITICAL)  â”‚         â”‚
â”‚  â”‚â€¢ Delete      â”‚  â”‚â€¢ Validate    â”‚  â”‚â€¢ Release IP  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚           Agent Client (HTTPS)                   â”‚          â”‚
â”‚  â”‚  â€¢ Health Check                                  â”‚          â”‚
â”‚  â”‚  â€¢ Add Peer (register Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ)                â”‚          â”‚
â”‚  â”‚  â€¢ Remove Peer                                   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Infrastructure Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PostgreSQL   â”‚  â”‚  VPN Agent API â”‚  â”‚  Redis (cache)  â”‚  â”‚
â”‚  â”‚   (Prisma)     â”‚  â”‚    (HTTPS)     â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚â€¢ VpnConfig     â”‚  â”‚â€¢ Port 51821    â”‚  â”‚â€¢ Future stats   â”‚  â”‚
â”‚  â”‚â€¢ IpPool        â”‚  â”‚â€¢ Self-signed   â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚â€¢ VpnServer     â”‚  â”‚  SSL cert      â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

### 1. IpPoolService (`ip-pool.service.ts`)

**ğŸš¨ CRITICAL: Race Condition Protection**

ĞŸÑ€Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ€Ğ¸ÑĞº Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ñ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ IP Ğ´Ğ²ÑƒĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑĞ¼. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: **SELECT FOR UPDATE SKIP LOCKED**.

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ±ĞµĞ· Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸:**
```
Time â†’
T1: User A Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ IP
T2: User B Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ IP
T3: User A SELECT â†’ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ 10.0.1.2
T4: User B SELECT â†’ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ 10.0.1.2 (Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ!)
T5: User A UPDATE (allocated=true)
T6: User B UPDATE (allocated=true)
Result: âŒ ĞšĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚! ĞĞ±Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ IP
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹:**
```sql
SELECT * FROM ip_pools
WHERE server_id = $1 AND is_allocated = false
ORDER BY ip_address
LIMIT 1
FOR UPDATE SKIP LOCKED
```

**ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:**
- `FOR UPDATE` - Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
- `SKIP LOCKED` - ĞµÑĞ»Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ĞµĞ¹, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ĞµÑ‘ Ğ¸ Ğ±ĞµÑ€ĞµÑ‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ

**Flow:**
```
Time â†’
T1: User A Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ IP
T2: User B Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ IP
T3: User A SELECT FOR UPDATE â†’ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ 10.0.1.2
T4: User B SELECT FOR UPDATE â†’ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ 10.0.1.2, Ğ±ĞµÑ€ĞµÑ‚ 10.0.1.3
T5: User A UPDATE (allocated=true) + COMMIT
T6: User B UPDATE (allocated=true) + COMMIT
Result: âœ… User A = 10.0.1.2, User B = 10.0.1.3
```

**ĞœĞµÑ‚Ğ¾Ğ´Ñ‹:**
- `allocateIp(serverId, subscriptionId)` - **Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ** Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ IP
- `releaseIp(ipPoolId)` - Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ IP Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ğ¿ÑƒĞ»
- `releaseIpBySubscription(subscriptionId)` - Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… IP Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
- `getAvailableIpCount(serverId)` - ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ñ… IP
- `initializeServerIpPool(serverId, subnet)` - ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ÑƒĞ»Ğ° IP Ğ¸Ğ· CIDR

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**
```typescript
// âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
const ip = await ipPoolService.allocateIp(serverId, subscriptionId);

// âŒ ĞĞ•ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ½Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
const availableIps = await prisma.ipPool.findMany({
  where: { isAllocated: false }
});
// Race condition! Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ğ·ÑÑ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ IP
```

### 2. WireGuardService (`wireguard.service.ts`)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹ WireGuard

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:** Curve25519 (X25519) - elliptic curve Ğ´Ğ»Ñ ECDH key exchange

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Node.js crypto API (ĞĞ• Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸!)

```typescript
// âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - Node.js crypto
import { generateKeyPairSync } from 'crypto';

const { privateKey, publicKey } = generateKeyPairSync('x25519', {
  privateKeyEncoding: { type: 'pkcs8', format: 'der' },
  publicKeyEncoding: { type: 'spki', format: 'der' }
});

// Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑÑ‹Ñ€Ñ‹Ğµ 32-Ğ±Ğ°Ğ¹Ñ‚Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ğ· DER Ğ¾Ğ±ĞµÑ€Ñ‚ĞºĞ¸
const privateKeyRaw = privateKey.subarray(-32);
const publicKeyRaw = publicKey.subarray(-32);

// ĞšĞ¾Ğ´Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² base64 (Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ WireGuard)
const privateKeyBase64 = privateKeyRaw.toString('base64'); // 44 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°
```

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ½Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸:**
- Native crypto = Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- ĞœĞµĞ½ÑŒÑˆĞµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ = Ğ¼ĞµĞ½ÑŒÑˆĞµ attack surface
- Ğ‘Ñ‹ÑÑ‚Ñ€ĞµĞµ (Ğ½ĞµÑ‚ overhead)

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ĞºĞ»ÑÑ‡ĞµĞ¹:**
- **Ğ”Ğ»Ğ¸Ğ½Ğ°:** 32 Ğ±Ğ°Ğ¹Ñ‚Ğ° (256 Ğ±Ğ¸Ñ‚)
- **ĞšĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°:** Base64
- **Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:** 44 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, `aBcDeFgHiJkLmNoPqRsTuVwXyZ0123456789+/A=`)

**ĞœĞµÑ‚Ğ¾Ğ´Ñ‹:**
- `generateKeyPair()` - Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ°Ñ€Ñ‹ ĞºĞ»ÑÑ‡ĞµĞ¹
- `generatePresharedKey()` - PSK Ğ´Ğ»Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
- `generateKeys(withPresharedKey)` - Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ğ±Ğ¾Ñ€ ĞºĞ»ÑÑ‡ĞµĞ¹
- `isValidKey(key)` - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° ĞºĞ»ÑÑ‡Ğ°

**Preshared Key (PSK):**
- ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹, Ğ½Ğ¾ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹
- Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ĞºĞ²Ğ°Ğ½Ñ‚Ğ¾Ğ²Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğ¾Ğ² (post-quantum security)
- Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `randomBytes(32)`

### 3. AgentClient (`agent-client.ts`)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** ĞšĞ¾Ğ¼Ğ¼ÑƒĞ½Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ VPN Agent API Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ñ…

**ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»:** HTTPS Ñ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¼ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ¼

**ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ:** Bearer token (Ğ¸Ğ· `VpnServer.agentBearerToken`)

**Endpoints:**

#### GET /health
ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°.

**Response:**
```json
{
  "status": "ok",
  "version": "3.1",
  "secure": true,
  "https": true
}
```

#### POST /wg/addpeer
Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ peer Ğ½Ğ° WireGuard ÑĞµÑ€Ğ²ĞµÑ€Ğµ.

**Request:**
```json
{
  "public_key": "client_public_key_base64",
  "allowed_ips": "10.0.1.5/32",
  "preshared_key": "psk_base64" // Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾
}
```

**Response:**
```json
{
  "success": true
}
```

**ĞĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ:**
```bash
sudo wg set wg0 peer <public_key> allowed-ips <allowed_ips>
```

#### POST /wg/removepeer
Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ peer Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°.

**Request:**
```json
{
  "public_key": "client_public_key_base64"
}
```

**ĞĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ:**
```bash
sudo wg set wg0 peer <public_key> remove
```

**Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Agent:**
- âœ… HTTPS Ñ ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¼ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ¼
- âœ… Bearer token Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… IP whitelist (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ backend Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒÑÑ)
- âœ… Rate limiting (60 req/min)
- âœ… Sudo whitelist (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹)

**ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°:**
```bash
# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
AGENT_PORT=51821
AGENT_SECRET=<bearer_token>
ALLOWED_IP=<backend_server_ip>
```

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚:** Self-signed ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚

```typescript
// Ğ’ agent-client.ts Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ°
const httpsAgent = new https.Agent({
  rejectUnauthorized: false, // Agent Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ self-signed cert
});
```

**âš ï¸ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ:** Ğ­Ñ‚Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾, Ñ‚Ğ°Ğº ĞºĞ°Ğº:
1. IP whitelist Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
2. Bearer token Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ
3. Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ² Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞµÑ‚Ğ¸ (Ğ½Ğµ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹)

### 4. VpnService (`vpn.service.ts`)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ VPN Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

#### generateConfig()

**ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ flow Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸                                        â”‚
â”‚    â€¢ Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚?                                             â”‚
â”‚    â€¢ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°?                                                â”‚
â”‚    â€¢ ĞŸÑ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ?                               â”‚
â”‚    â€¢ ĞĞµ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²?                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞµÑ€Ğ²ĞµÑ€Ğ°                                             â”‚
â”‚    â€¢ Ğ•ÑĞ»Ğ¸ serverId ÑƒĞºĞ°Ğ·Ğ°Ğ½ â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ            â”‚
â”‚    â€¢ Ğ˜Ğ½Ğ°Ñ‡Ğµ â†’ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ñƒ:                           â”‚
â”‚      - Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ = active                                       â”‚
â”‚      - Ğ•ÑÑ‚ÑŒ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ IP                                     â”‚
â”‚      - ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° (currentUsers / maxUsers)        â”‚
â”‚      - ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ (priority DESC)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ¹ (Curve25519)                             â”‚
â”‚    â€¢ Private key (32 bytes)                                  â”‚
â”‚    â€¢ Public key (32 bytes)                                   â”‚
â”‚    â€¢ Preshared key (32 bytes) - Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Ğ’Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ IP Ğ¸Ğ· Ğ¿ÑƒĞ»Ğ° (Ğ¢Ğ ĞĞĞ—ĞĞšĞ¦Ğ˜Ğ¯!)                        â”‚
â”‚    â€¢ SELECT FOR UPDATE SKIP LOCKED                           â”‚
â”‚    â€¢ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ»ÑÑ‡ĞµĞ¹ Ğ² IpPool                              â”‚
â”‚    â€¢ ĞŸĞ¾Ğ¼ĞµÑ‚ĞºĞ° isAllocated = true                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Health check Ğ°Ğ³ĞµĞ½Ñ‚Ğ°                                       â”‚
â”‚    â€¢ GET /health                                             â”‚
â”‚    â€¢ Ğ•ÑĞ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ â†’ rollback IP allocation                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ peer Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ                               â”‚
â”‚    â€¢ POST /wg/addpeer                                        â”‚
â”‚    â€¢ Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° â†’ rollback IP allocation                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°                                      â”‚
â”‚    [Interface]                                               â”‚
â”‚    PrivateKey = <client_private_key>                         â”‚
â”‚    Address = 10.0.1.5/32                                     â”‚
â”‚    DNS = 1.1.1.1, 8.8.8.8                                    â”‚
â”‚                                                              â”‚
â”‚    [Peer]                                                    â”‚
â”‚    PublicKey = <server_public_key>                           â”‚
â”‚    PresharedKey = <psk> # ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ                          â”‚
â”‚    Endpoint = vpn.example.com:51820                          â”‚
â”‚    AllowedIPs = 0.0.0.0/0, ::/0                              â”‚
â”‚    PersistentKeepalive = 25                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ” (VpnConfig)                               â”‚
â”‚    â€¢ subscriptionId                                          â”‚
â”‚    â€¢ serverId                                                â”‚
â”‚    â€¢ ipPoolId                                                â”‚
â”‚    â€¢ privateKey, publicKey, presharedKey                     â”‚
â”‚    â€¢ configText                                              â”‚
â”‚    â€¢ isActive = true                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°                             â”‚
â”‚    â€¢ currentUsers++                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
                âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!
```

**Rollback Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…:**
- Ğ•ÑĞ»Ğ¸ Agent Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ â†’ `releaseIp()`
- Ğ•ÑĞ»Ğ¸ addPeer Ğ¾ÑˆĞ¸Ğ±ĞºĞ° â†’ `releaseIp()`
- IP Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ² Ğ¿ÑƒĞ» Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

#### rotateConfig()

**ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ:**
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼ĞµÑ‚Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ¹
- ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ security policy
- Ğ¡Ğ¼ĞµĞ½Ğ° IP Ğ°Ğ´Ñ€ĞµÑĞ°

**Flow:**
```
1. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
2. Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ (isActive = false)
3. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ peer Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ° (removePeer)
4. ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ IP
5. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ (generateConfig)
6. Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ { oldIpAddress, newConfig }
```

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚:** Ğ”Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ removePeer ÑƒĞ¿Ğ°Ğ», Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ - ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ peer ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½

#### deleteConfig()

**Flow:**
```
1. ĞĞ°Ğ¹Ñ‚Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ¿Ğ¾ ID
2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ownership (Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞµ?)
3. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ peer Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
4. ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ IP
5. ĞŸĞ¾Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ isActive = false (Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· Ğ‘Ğ”!)
6. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
```

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· Ğ‘Ğ”:**
- ĞÑƒĞ´Ğ¸Ñ‚ - Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²
- Forensics - ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞµĞ» Ğ¸Ğ½Ñ†Ğ¸Ğ´ĞµĞ½Ñ‚
- ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° - ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ»Ğ¾ÑÑŒ

## API Endpoints

### POST /api/vpn/generate

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ VPN ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°

**Auth:** Required (Bearer token)

**Request:**
```json
{
  "subscriptionId": "uuid",
  "serverId": "uuid" // Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "config": {
      "subscriptionId": "uuid",
      "serverId": "uuid",
      "privateKey": "aBc...=",
      "publicKey": "xYz...=",
      "presharedKey": "123...=",
      "ipAddress": "10.0.1.5",
      "serverPublicKey": "sRv...=",
      "serverEndpoint": "vpn.example.com:51820",
      "allowedIPs": "0.0.0.0/0, ::/0",
      "dns": "1.1.1.1, 8.8.8.8",
      "configText": "[Interface]\nPrivateKey = ..."
    }
  }
}
```

**configText** - Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° Ğ² WireGuard ĞºĞ»Ğ¸ĞµĞ½Ñ‚

**ĞÑˆĞ¸Ğ±ĞºĞ¸:**
- `400` - Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ¸Ğ»Ğ¸ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½
- `404` - Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°
- `503` - Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… IP Ğ¸Ğ»Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½

### POST /api/vpn/rotate

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ IP + Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸)

**Auth:** Required

**Request:**
```json
{
  "subscriptionId": "uuid"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "result": {
      "oldIpAddress": "10.0.1.5",
      "newConfig": { /* VpnConfig */ }
    }
  }
}
```

### GET /api/vpn/:configId

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ¿Ğ¾ ID

**Auth:** Required

**Response (200):**
```json
{
  "success": true,
  "data": {
    "config": { /* VpnConfig */ }
  }
}
```

### DELETE /api/vpn/:configId?subscriptionId=xxx

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³

**Auth:** Required

**Query Params:**
- `subscriptionId` - Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ownership

**Response (200):**
```json
{
  "success": true,
  "data": {
    "success": true
  }
}
```

### GET /api/vpn/subscription/:subscriptionId

**ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:** Ğ’ÑĞµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸

**Auth:** Required

**Response (200):**
```json
{
  "success": true,
  "data": {
    "configs": [ /* Ğ¼Ğ°ÑÑĞ¸Ğ² VpnConfig */ ],
    "count": 3
  }
}
```

## WireGuard Client Setup

### iOS

1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ WireGuard Ğ¸Ğ· App Store
2. ĞĞ°Ğ¶Ğ°Ñ‚ÑŒ "+" â†’ "Create from file or archive"
3. Ğ’ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ `configText` Ğ¸Ğ· API response
4. Ğ˜Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ QR ĞºĞ¾Ğ´ Ğ¸ Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ

### Android

1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ WireGuard Ğ¸Ğ· Google Play
2. "+" â†’ "Import from file"
3. Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ñ `configText`

### macOS / Linux / Windows

1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ WireGuard: https://www.wireguard.com/install/
2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ `configText` Ğ² Ñ„Ğ°Ğ¹Ğ» `wg0.conf`
3. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ:
   ```bash
   # Linux
   sudo wg-quick up /path/to/wg0.conf

   # macOS
   sudo wg-quick up wg0
   ```

## Database Schema

### VpnConfig
```prisma
model VpnConfig {
  id             String   @id @default(uuid())
  subscriptionId String
  serverId       String
  ipPoolId       String

  privateKey     String
  publicKey      String
  presharedKey   String?

  configText     String   @db.Text
  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
```

### IpPool
```prisma
model IpPool {
  id           String    @id @default(uuid())
  serverId     String
  ipAddress    String

  isAllocated  Boolean   @default(false)
  allocatedTo  String?   // subscription ID
  allocatedAt  DateTime?
  releasedAt   DateTime?

  privateKey   String?
  publicKey    String?
  presharedKey String?

  @@unique([serverId, ipAddress])
  @@index([serverId, isAllocated])
}
```

## Troubleshooting

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: "IP Pool Exhausted"

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** ĞĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ñ‹Ğµ IP Ğ°Ğ´Ñ€ĞµÑĞ°

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
```sql
-- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ IP Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾
SELECT COUNT(*) FROM ip_pools
WHERE server_id = 'xxx' AND is_allocated = false;

-- ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ²ÑĞµ IP ÑĞµÑ€Ğ²ĞµÑ€Ğ°
SELECT ip_address, is_allocated, allocated_to
FROM ip_pools
WHERE server_id = 'xxx'
ORDER BY ip_address;
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ IP:
```typescript
await ipPoolService.initializeServerIpPool(serverId, '10.0.2.0/24');
// Ğ¡Ğ¾Ğ·Ğ´Ğ°ÑÑ‚ ~250 IP Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ²
```

2. Ğ˜Ğ»Ğ¸ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ:
```sql
-- ĞĞ°Ğ¹Ñ‚Ğ¸ "Ğ·Ğ°Ğ²Ğ¸ÑÑˆĞ¸Ğµ" IP (allocated, Ğ½Ğ¾ subscription expired)
SELECT ip.* FROM ip_pools ip
JOIN subscriptions s ON ip.allocated_to = s.id
WHERE ip.is_allocated = true
  AND s.status = 'expired';

-- ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¸Ñ…
UPDATE ip_pools SET is_allocated = false, released_at = NOW()
WHERE id IN (...);
```

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: "Agent is not responding"

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** VPN Agent Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
```bash
# ĞĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
systemctl status vpn-agent

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸
journalctl -u vpn-agent -f

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ»ÑƒÑˆĞ°ĞµÑ‚ Ğ»Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚
ss -tlnp | grep 51821

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ firewall
ufw status | grep 51821
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
1. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ°Ğ³ĞµĞ½Ñ‚:
```bash
systemctl restart vpn-agent
```

2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚:
```bash
openssl s_client -connect localhost:51821
```

3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Bearer token Ğ² Ğ‘Ğ” ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼ Ğ² Ğ°Ğ³ĞµĞ½Ñ‚Ğµ

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: "Race condition - Ğ´Ğ²Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ IP"

**Ğ­Ñ‚Ğ¾ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾Ğ¹Ñ‚Ğ¸!** Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ¾:

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
```sql
-- ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹
SELECT ip_address, COUNT(*)
FROM ip_pools
WHERE is_allocated = true
GROUP BY ip_address
HAVING COUNT(*) > 1;
```

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** Ğ›Ğ¸Ğ±Ğ¾ ĞºĞ¾Ğ´ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ, Ğ»Ğ¸Ğ±Ğ¾ Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ row-level locking

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ PostgreSQL (Ğ½Ğµ MySQL/SQLite)
2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ `allocateIp()` Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ĞµĞ¹
3. Ğ’Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: "Invalid WireGuard key format"

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** ĞšĞ»ÑÑ‡ Ğ½Ğµ 44 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° Ğ¸Ğ»Ğ¸ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ base64

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
```typescript
const key = "...";
console.log(key.length); // Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ 44
console.log(/^[A-Za-z0-9+/]{43}=$/.test(key)); // Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ true
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞŸĞµÑ€ĞµĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ - Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ!

## Security Considerations

### 1. Private Key Exposure

**Ğ Ğ¸ÑĞº:** Private key Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ Ğ² plain text

**ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ:**
- âœ… HTTPS Ğ´Ğ»Ñ API
- âœ… Ğ¢Ğ¾ĞºĞµĞ½Ñ‹ ÑĞµÑÑĞ¸Ğ¹ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
- âœ… Private key Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
- âš ï¸ TODO: ĞĞ¿Ñ†Ğ¸Ñ end-to-end encryption (client-side key generation)

### 2. Server Compromise

**Ğ Ğ¸ÑĞº:** Ğ•ÑĞ»Ğ¸ Agent ÑĞµÑ€Ğ²ĞµÑ€ ÑĞºĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼ĞµÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‰Ğ¸Ğ¹ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº

**ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ:**
- âœ… Preshared Key (post-quantum protection)
- âœ… IP whitelist Ğ½Ğ° Agent
- âœ… Bearer token Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- âœ… Sudo whitelist (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ğ»ĞµĞ³Ğ¸Ğ¸)
- âš ï¸ TODO: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ PSK ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 30 Ğ´Ğ½ĞµĞ¹

### 3. DoS Attack

**Ğ Ğ¸ÑĞº:** Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Ğ¸Ñ IP Ğ¿ÑƒĞ»Ğ°

**ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ:**
- âœ… Limit ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ (plan.maxConfigs)
- âœ… Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº
- âš ï¸ TODO: Rate limiting Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

## Monitoring

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ:

```typescript
// IP Pool utilization
SELECT
  s.name,
  COUNT(CASE WHEN ip.is_allocated THEN 1 END) as used,
  COUNT(*) as total,
  ROUND(100.0 * COUNT(CASE WHEN ip.is_allocated THEN 1 END) / COUNT(*), 2) as utilization_pct
FROM vpn_servers s
LEFT JOIN ip_pools ip ON ip.server_id = s.id
GROUP BY s.id;

// Active configs per server
SELECT server_id, COUNT(*)
FROM vpn_configs
WHERE is_active = true
GROUP BY server_id;

// Config creation rate
SELECT DATE(created_at), COUNT(*)
FROM vpn_configs
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at);
```

### Alerts:

- IP utilization > 80% â†’ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ IP Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€
- Agent health check fails â†’ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
- ĞĞ½Ğ¾Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ rate ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² â†’ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ°Ñ‚Ğ°ĞºĞ°

## Testing

### Unit Tests
```bash
npm test -- src/modules/vpn
```

### Integration Tests

**Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°:**
```bash
curl -X POST http://localhost:3000/api/vpn/generate \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "subscriptionId": "uuid"
  }'
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Agent:**
```bash
# Health check
curl -k https://<server>:51821/health

# Add peer (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Bearer token)
curl -k -X POST https://<server>:51821/wg/addpeer \
  -H "Authorization: Bearer <agent_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "public_key": "xxx",
    "allowed_ips": "10.0.1.5/32"
  }'
```

## Roadmap

- [ ] ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ PSK (post-quantum security)
- [ ] Client-side key generation (zero-knowledge)
- [ ] Multi-hop VPN (chain Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²)
- [ ] IPv6 support
- [ ] Automatic failover Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
- [ ] Bandwidth tracking per config
- [ ] GeoIP blocking rules
